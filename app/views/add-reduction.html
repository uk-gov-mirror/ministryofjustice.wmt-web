{% extends "includes/layout.html" %} 

{% block content %}

<main id="content" role="main">
  {% include "includes/breadcrumbs.html" %}

  {% if reduction %}
    {% set headerText='Reduction' %}
    {% set reductionText='Showing reduction for ' %}
    {% if reduction.status !== 'ARCHIVED' %}
      {% if reduction.id %}
        {% set submitButtonText='Save changes' %}
        {% set formAction='/' + workloadType + '/offender-manager/' +  linkId  + '/edit-reduction' %}
        {% set formMethod='POST' %}
      {% else %}
        {% set headerText='New reduction' %}
        {% set reductionText='Add a new reduction for ' %}
        {% set submitButtonText='Add reduction' %}
        {% set formAction='/' + workloadType + '/offender-manager/' + linkId +'/add-reduction' %}
        {% set formMethod='POST' %}
      {% endif %}
    {% else %}
      {% set submitButtonText='Back to Reductions' %}
      {% set formAction='/' + workloadType + '/offender-manager/' + linkId + '/reductions' %}
      {% set formMethod='GET' %}
    {% endif %}
  {% else %}
    {% set headerText='New reduction' %}
    {% set reductionText='Add a new reduction for ' %}
    {% set submitButtonText='Add reduction' %}
    {% set formAction='/' + workloadType + '/offender-manager/' + linkId +'/add-reduction' %}
    {% set formMethod='POST' %}  
  {% endif %}

  {% include "includes/validation-error-messages.html" %}

  <header class="heading-xlarge" style="margin-top:0; margin-bottom:0">{{ headerText }}</header>
  <p class="lede">{{ reductionText }}<span class="bold">{{ title }}</span></p>
  {% set first = true %}
  <form action="{{ formAction }}" method="{{formMethod}}" id="reductionForm">
    <input type="hidden" name="reductionId" value="{{reduction.id}}"/>
    <div class="form-group" id="reduction_reason_selection">
      <label class="form-label-bold" for="select-box">Reason for reduction</label>
      {% if errors['reasonForReductionId'][0] %}
        <span class="error-message">{{ errors['reasonForReductionId'][0] }}</span>
      {% endif %}
      <select class="form-control" id="select-box" name="reasonForReductionId" selected="{{ reduction.reasonId }}" onChange="populateHours(), calculateExpiry(), enableAddReduction()"> 
        <option value="select" disabled selected>Please select a reason...</option>
        {% for reason in referenceData %}
        <option value="{{ reason.id }}" {% if reason.id == reduction.reasonId %} selected {% endif %}>{{ reason.reasonShortName }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group" id="reduction_hours">
      {% if errors['reductionHours'][0] %}
        <span class="error-message">{{ errors['reductionHours'][0] }}</span>
      {% endif %}
      <label class="form-label-bold" for="hours">Hours</label>
      <input class="form-control" id="hours" name="reductionHours" style="width: 100px" value="{{reduction.hours}}">
    </div>

    <div class="form-group" id="reductionStartDate">
      <fieldset>
        <legend>
          <span class="form-label-bold">Reduction start date</span>
          <span class="form-hint">For example, 31 3 1980</span>
        </legend>
        {% if errors['reductionStartDate'][0] %}
          <span class="error-message">{{ errors['reductionStartDate'][0] }}</span>
        {% endif %}
        <div class="form-date" id="reduction_start_day">
          <div class="form-group form-group-day">
            <label class="form-label" for="start-day">Day</label>
            <input class="form-control" id="start-day" name="redStartDay" value="{{ reduction.start_day }}" type="number" onchange="calculateExpiry()">
          </div>
          <div class="form-group form-group-month" id="reduction_start_month">
            <label class="form-label" for="start-month">Month</label>
            <input class="form-control" id="start-month" name="redStartMonth" value="{{ reduction.start_month }}" type="number" onchange="calculateExpiry()">
          </div>
          <div class="form-group form-group-year" id="reduction_start_year">
            <label class="form-label" for="start-year">Year</label>
            <input class="form-control" id="start-year" name="redStartYear" value="{{ reduction.start_year }}" type="number" onchange="calculateExpiry()">
          </div>
        </div>
      </fieldset>
    </div>

    <div class="form-group" id="reductionEndDate">
      <fieldset>
        <legend>
          <span class="form-label-bold">Reduction end date</span>
          <span class="form-hint">For example, 31 3 1980</span>
        </legend>
        {% if errors['reductionEndDate'][0] %}
          <span class="error-message">{{ errors['reductionEndDate'][0] }}</span>
        {% endif %}
        <div class="form-date" id="reduction_end_day">
          <div class="form-group form-group-day">
            <label class="form-label" for="end-day">Day</label>
            <input class="form-control" id="end-day" name="redEndDay" value="{{ reduction.end_day }}" type="number">
          </div>
          <div class="form-group form-group-month" id="reduction_end_month">
            <label class="form-label" for="end-month">Month</label>
            <input class="form-control" id="end-month" name="redEndMonth" value="{{ reduction.end_month }}" type="number">
          </div>
          <div class="form-group form-group-year" id="reduction_end_year">
            <label class="form-label" for="end-year">Year</label>
            <input class="form-control" id="end-year" name="redEndYear" value="{{ reduction.end_year }}" type="number">
          </div>
        </div>
      </fieldset>
    </div>

    <div class="form-group">
      {% if errors['notes'][0] %}
        <span class="error-message">{{ errors['notes'][0] }}</span>
      {% endif %}
      <label class="form-label-bold" for="textarea">Additional notes</label>
      <textarea class="form-control form-control-3-4" name="notes" id="textarea" rows="5">{{ reduction.notes }}</textarea>
    </div> 
    {% include "includes/csrf-hidden-input.html"%}
    <input id="submit-button" class="button" type="submit" value="{{ submitButtonText }}">
  </form>
  {% if reduction %}
  <h2 class="heading-small">Other options</h2>
  <form name="archiveReduction" method="POST" action="/{{ workloadType }}/offender-manager/{{ linkId }}/update-reduction-status">
    <!-- Including the csrf-hidden-input.html hides the links -->
    <input type="hidden"  name="_csrf"  value="{{ csrfToken }}">
    <input type="hidden" name="reductionId" value="{{reduction.id}}">
    <input type="hidden" name="status" value="ARCHIVED">
  </form>
  
  <form name="deleteReduction" method="POST" action="/{{ workloadType }}/offender-manager/{{ linkId }}/update-reduction-status">
    <!-- Including the csrf-hidden-input.html hides the links -->
    <input type="hidden"  name="_csrf"  value="{{ csrfToken }}">
    <input type="hidden" name="reductionId" value="{{ reduction.id }}">
    <input type="hidden" name="status" value="DELETED">
  </form>
  <div>
  <ul>
    {% if reduction.status !== 'ARCHIVED' %}
    <li><a  href="javascript:document.archiveReduction.submit()">Archive reduction</a></li>
    {% endif %}
    <li><a  href="javascript:document.deleteReduction.submit()">Delete reduction</a></li>
  </ul>
  </div>
  {% endif %}
  <br>
  <details>

      <summary><span class="summary">Audit Log</span></summary>

      <table class="">
          <thead>
              <tr>
                  <th id="type">Reason</th>
                  <th id="hours">Hours</th>
                  <th id="comments">Comments</th>
                  <th id="start_date">Start Date</th>
                  <th id="end_date">End Date</th>
                  <th id="status">Status</th>
                  <th id="action_date">Date</th>
                  <th id="user">User</th>
              </tr>
          </thead>
          <tbody class="">
              {% for reduction in reductionsHistory %}
              <tr>
                  <td headers="type">{{ reduction.reasonShortName }}</td>
                  <td headers="hours">{{ reduction.hours }}</td>
                  <td headers="comments">{{ reduction.notes }}</td>
                  <td headers="start_date">{{ reduction.reductionStartDate }}</td>
                  <td headers="end_date">{{ reduction.reductionEndDate }}</td>     
                  <td headers="status">{{ reduction.status }}</td>                
                  <td headers="action_date">{{ reduction.updatedDate }}</td>    
                  <td headers="user">{{ reduction.name }}</td>    
              </tr>
              {% endfor %}
          </tbody>
      </table>
    </details>
</main>
{% endblock %} {% block body_end %}
<script src="/public/javascripts/vendor/jquery.min.js"></script>
<script type="text/javascript">
  var refData = {{ referenceData | dump | safe }}
</script>
<script src="/public/javascripts/add-reduction.js"></script>
{% if not reduction %}
<script>
  $(function(){
    $('#submit-button').prop('disabled', true);
  });
</script>
{% endif %}
{% if not reduction.isEnabled %}
<script>
  $(function(){
    $('#submit-button').prop('disabled', true);
  });
</script>
{% endif %}
{% if reduction.status === 'ARCHIVED' %}
<script>
    $(function(){
      $('#select-box').prop('disabled', true);
      $('#end-year').prop('readonly', true);
      $('#end-month').prop('readonly', true);
      $('#end-day').prop('readonly', true);
      $('#start-year').prop('readonly', true);
      $('#start-month').prop('readonly', true);
      $('#start-day').prop('readonly', true);
      $('#hours').prop('readonly', true);
      $('#textarea').prop('readonly', true);
    });
</script>
{% endif %}
{% endblock %}